<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Custom visualiser example (ES5 version) | Akko Music Visualising Framework</title>

        <!-- Make the page look a bit nicer (this does not affect Akko) -->
        <link rel="stylesheet" href="/mixer/css/prettify.css"/>

        <!-- Akko CSS -->
        <link rel="stylesheet" href="/mixer/dist/akko.min.css"/>

        <!-- Modern Mixer Styling -->
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
                color: #ffffff;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                min-height: 100vh;
                overflow-x: hidden;
            }
            
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            
            .header {
                text-align: center;
                margin-bottom: 40px;
                padding: 40px 0;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 20px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .header h1 {
                font-size: 3.5rem;
                font-weight: 700;
                background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
                background-size: 400% 400%;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                animation: gradientShift 4s ease-in-out infinite;
                margin-bottom: 10px;
            }
            
            @keyframes gradientShift {
                0%, 100% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
            }
            
            .header p {
                font-size: 1.2rem;
                opacity: 0.8;
                line-height: 1.6;
                max-width: 600px;
                margin: 0 auto;
            }
            
            .visualizer-container {
                background: rgba(0, 0, 0, 0.4);
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                border: 2px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                position: relative;
                overflow: hidden;
            }
            
            .visualizer-container::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255, 107, 107, 0.1), rgba(78, 205, 196, 0.1), rgba(69, 183, 209, 0.1));
                pointer-events: none;
                animation: pulseGlow 3s ease-in-out infinite;
            }
            
            @keyframes pulseGlow {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 0.6; }
            }
            
            #akko {
                height: 600px;
                border-radius: 15px;
                overflow: hidden;
                position: relative;
                z-index: 1;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            
            .controls-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-top: 30px;
            }
            
            .info-card {
                background: rgba(255, 255, 255, 0.05);
                padding: 25px;
                border-radius: 15px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(5px);
            }
            
            .info-card h3 {
                color: #4ecdc4;
                margin-bottom: 15px;
                font-size: 1.3rem;
            }
            
            .info-card ul {
                list-style: none;
                padding: 0;
            }
            
            .info-card li {
                padding: 8px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                opacity: 0.8;
            }
            
            .info-card li:last-child {
                border-bottom: none;
            }
            
            .feature-highlight {
                background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(78, 205, 196, 0.2));
                padding: 20px;
                border-radius: 15px;
                margin: 30px 0;
                border: 1px solid rgba(255, 255, 255, 0.2);
                text-align: center;
            }
            
            .feature-highlight strong {
                color: #ff6b6b;
            }
            
            /* Responsive Design */
            @media (max-width: 768px) {
                .container {
                    padding: 15px;
                }
                
                .header h1 {
                    font-size: 2.5rem;
                }
                
                .controls-info {
                    grid-template-columns: 1fr;
                    gap: 20px;
                }
                
                #akko {
                    height: 400px;
                }
                
                .visualizer-container {
                    padding: 20px;
                }
            }
            
            /* Loading animation for when Akko is initializing */
            .loading {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 200px;
                font-size: 1.2rem;
                opacity: 0.7;
            }
            
            .loading::after {
                content: '';
                width: 20px;
                height: 20px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-top: 2px solid #4ecdc4;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 10px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>MuizenMixer</h1>
                <p>Experience music through stunning 3D visualizations. Drop your tracks into our browser-based Akko visualizer and watch your audio come to life with interactive, real-time graphics.</p>
            </div>

            <div class="visualizer-container">
                <div id="akko"></div>
            </div>

            <div class="feature-highlight">
                <p><strong>Interactive Experience:</strong> Hover over the visualization to grab particles, click to add more, and watch as your music transforms into beautiful 3D art.</p>
            </div>

            <div class="controls-info">
                <div class="info-card">
                    <h3>🎵 How to Use</h3>
                    <ul>
                        <li>Click play to start the demo tracks</li>
                        <li>Drag and drop your own audio files</li>
                        <li>Hover over the visualization to interact</li>
                        <li>Click to add more visual elements</li>
                        <li>Enjoy the real-time audio-reactive graphics</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3>🎨 Visual Modes</h3>
                    <ul>
                        <li><strong>Cubes:</strong> 3D frequency-reactive cubes</li>
                        <li><strong>Wave:</strong> Animated wireframe terrain</li>
                        <li><strong>Sphere:</strong> Particle sphere visualization</li>
                        <li><strong>Bars:</strong> Classic frequency bars</li>
                        <li>Switch between modes using controls</li>
                    </ul>
                </div>
            </div>

            <div class="feature-highlight">
                <p>🚀 <strong>Coming Soon:</strong> Upload and share your remixes with the community under our collaborative culture contract!</p>
            </div>
        </div>

        <!-- Akko's dependencies -->
        <script src="https://cdn.jsdelivr.net/bluebird/latest/bluebird.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/86/three.min.js"></script>

        <!-- Debug dependencies -->
        <script>
            console.log('Dependencies loaded:');
            console.log('- Promise/Bluebird:', typeof Promise);
            console.log('- THREE.js:', typeof THREE);
        </script>

        <!-- Load Akko with proper error handling -->
        <script>
            // Clear any existing module system
            delete window.module;
            delete window.exports;
            delete window.require;
        </script>
        <script src="/mixer/dist/akko.min.js" onerror="console.error('Failed to load akko.min.js')"></script>
        <script>
            console.log('After akko.min.js - Akko:', typeof Akko);
            console.log('Window keys containing akko:', Object.keys(window).filter(k => k.toLowerCase().includes('akko')));
            
            // Check if it's in a different location
            if (typeof Akko === 'undefined') {
                console.log('Checking window object for Akko...');
                for (let key in window) {
                    if (key.toLowerCase().includes('akko') || (typeof window[key] === 'function' && window[key].toString().includes('Akko'))) {
                        console.log('Found potential Akko at window.' + key + ':', typeof window[key]);
                    }
                }
            }
        </script>

        <!-- Debug Akko loading -->
        <script>
            console.log('Akko loaded:', typeof Akko);
            if (typeof Akko === 'undefined') {
                console.error('❌ Akko failed to load!');
                alert('Akko framework failed to load. Check console for errors.');
            }
        </script>

        <!-- Defining our visualiser and starting Akko -->
        <script>
            // Amount of cubes to draw, must be a power of 2 since we're using it for `fftSize` below
            var CUBE_COUNT = 16;
            function CustomVisualiser() {
                Akko.Visualiser.call(this, {
                    code: 'Cv',
                    name: 'Custom Visualiser',
                    fftSize: CUBE_COUNT * 2,
                });
            }
            CustomVisualiser.prototype = Object.create(Akko.Visualiser.prototype);
            CustomVisualiser.prototype.constructor = CustomVisualiser;
            CustomVisualiser.prototype.onInit = function(data) {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, data.width / data.height, 0.1, 100);
                this.camera.position.z = 10;
                this.camera.lookAt(new THREE.Vector3(0, 0, 0));
                this.scene.add(this.camera);
                this.cubes = [];
                var geometry = new THREE.BoxGeometry(1, 1, 1);
                var xOffset = -CUBE_COUNT / 2 + 0.5;
                var hslStep = 1 / CUBE_COUNT;
                for (var i = 0; i < CUBE_COUNT; i++) {
                    var material = new THREE.MeshBasicMaterial({color: 0xffffff});
                    material.color.setHSL(hslStep * i, 1, 0.5);
                    var cube = new THREE.Mesh(geometry, material);
                    cube.position.set(xOffset + i, 0, 0);
                    this.scene.add(cube);
                    this.cubes.push(cube);
                }
            };
            CustomVisualiser.prototype.onUpdate = function(data) {
                for (var i = 0; i < CUBE_COUNT; i++) {
                    var cube = this.cubes[i];
                    var frequency = data.frequencyData[i];
                    var timeDomain = data.timeDomainData[i];
                    cube.scale.y = this.lerp(cube.scale.y, frequency * timeDomain, 0.1);
                }
                data.renderer.render(this.scene, this.camera);
            };
            CustomVisualiser.prototype.onDestroy = function() {
                delete this.scene;
                delete this.camera;
                delete this.cubes;
            };


            // Wave Visualizer based on official Akko patterns
            class WaveVisualiser extends Akko.Visualiser {
                constructor() {
                    super({
                        code: 'Wv',
                        name: 'Wave Terrain',
                        fftSize: 128,
                        smoothingTimeConstant: 0.8,
                    });
                }

                onInit(data) {
                    this.setupSceneAndCamera(data);
                    this.setupWavePlane();
                }

                setupSceneAndCamera(data) {
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(60, data.width / data.height, 0.1, 100);
                    this.camera.position.set(0, 15, 25);
                    this.camera.lookAt(new THREE.Vector3(0, 0, 0));
                    this.scene.add(this.camera);
                }

                setupWavePlane() {
                    // Create wireframe plane similar to official visualizers
                    let geometry = new THREE.PlaneGeometry(30, 30, 32, 32);
                    let material = new THREE.MeshBasicMaterial({
                        color: 0x00ff88,
                        wireframe: true,
                        transparent: true,
                        opacity: 0.8
                    });
                    this.mesh = new THREE.Mesh(geometry, material);
                    this.mesh.rotation.x = -Math.PI / 2; // Lay flat
                    this.scene.add(this.mesh);
                    
                    // Store original vertex positions
                    this.originalVertices = [];
                    for (let i = 0; i < geometry.vertices.length; i++) {
                        this.originalVertices[i] = geometry.vertices[i].clone();
                    }
                }

                onUpdate(data) {
                    // Animate vertices based on frequency data
                    for (let i = 0; i < this.mesh.geometry.vertices.length; i++) {
                        let vertex = this.mesh.geometry.vertices[i];
                        let freqIndex = Math.floor((i / this.mesh.geometry.vertices.length) * data.frequencyData.length);
                        let frequency = Math.abs(data.frequencyData[freqIndex]);
                        let timeDomain = data.timeDomainData[freqIndex];
                        
                        let value = frequency * timeDomain;
                        let newZ = this.lerp(vertex.z, value * 10, 0.1);
                        vertex.z = newZ;
                    }
                    
                    this.mesh.geometry.verticesNeedUpdate = true;
                    this.mesh.rotation.z += 0.005;
                    
                    // Color cycling
                    let avgFreq = data.frequencyData.reduce((a, b) => a + b, 0) / data.frequencyData.length;
                    this.mesh.material.color.setHSL(0.3 + avgFreq * 0.4, 0.8, 0.6);
                    
                    data.renderer.render(this.scene, this.camera);
                }

                onResize(data) {
                    this.camera.aspect = data.width / data.height;
                    this.camera.updateProjectionMatrix();
                }

                onDestroy() {
                    delete this.scene;
                    delete this.camera;
                    delete this.mesh;
                }
            }

            // Particle Sphere Visualizer
            class SphereVisualiser extends Akko.Visualiser {
                constructor() {
                    super({
                        code: 'Sp',
                        name: 'Sphere Visualiser',
                        fftSize: 256,
                        smoothingTimeConstant: 0.3,
                    });
                }
            }
            SphereVisualiser.prototype.onInit = function(data) {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, data.width / data.height, 0.1, 1000);
                this.camera.position.z = 30;
                this.scene.add(this.camera);
                
                this.particles = [];
                var particleCount = 200;
                var geometry = new THREE.SphereGeometry(0.2, 8, 8);
                
                for (var i = 0; i < particleCount; i++) {
                    var material = new THREE.MeshBasicMaterial({
                        color: new THREE.Color().setHSL(i / particleCount, 1, 0.5)
                    });
                    var particle = new THREE.Mesh(geometry, material);
                    
                    // Position particles in a sphere
                    var phi = Math.acos(-1 + (2 * i) / particleCount);
                    var theta = Math.sqrt(particleCount * Math.PI) * phi;
                    var radius = 15;
                    
                    particle.position.x = radius * Math.cos(theta) * Math.sin(phi);
                    particle.position.y = radius * Math.sin(theta) * Math.sin(phi);
                    particle.position.z = radius * Math.cos(phi);
                    
                    particle.originalPosition = particle.position.clone();
                    this.scene.add(particle);
                    this.particles.push(particle);
                }
            };
            SphereVisualiser.prototype.onUpdate = function(data) {
                for (var i = 0; i < this.particles.length; i++) {
                    var particle = this.particles[i];
                    var freqIndex = Math.floor((i / this.particles.length) * data.frequencyData.length);
                    var scale = 1 + data.frequencyData[freqIndex] * 2;
                    
                    particle.scale.setScalar(scale);
                    particle.material.color.setHSL((i / this.particles.length + Date.now() * 0.0001) % 1, 1, 0.5);
                    
                    // Rotate the entire sphere
                    particle.position.copy(particle.originalPosition);
                    particle.position.applyAxisAngle(new THREE.Vector3(0, 1, 0), Date.now() * 0.001);
                }
                data.renderer.render(this.scene, this.camera);
            };
            SphereVisualiser.prototype.onDestroy = function() {
                delete this.scene;
                delete this.camera;
                delete this.particles;
            };

            // Frequency Bars Visualizer based on official Akko BarVisualiser
            class BarsVisualiser extends Akko.Visualiser {
                constructor() {
                    super({
                        code: 'Br',
                        name: 'Frequency Bars',
                        fftSize: 64,
                        smoothingTimeConstant: 0.9,
                    });
                }

                onInit(data) {
                    this.setupSceneAndCamera(data);
                    this.setupBars();
                }

                setupSceneAndCamera(data) {
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(60, data.width / data.height, 0.1, 100);
                    this.camera.position.set(0, 8, 15);
                    this.camera.lookAt(new THREE.Vector3(0, 0, 0));
                    this.cameraPivot = new THREE.Object3D();
                    this.cameraPivot.add(this.camera);
                    this.scene.add(this.cameraPivot);
                }

                setupBars() {
                    this.bars = [];
                    const BAR_COUNT = 32;
                    let geometry = new THREE.BoxGeometry(0.4, 1, 0.4);
                    
                    for (let i = 0; i < BAR_COUNT; i++) {
                        let hue = i / BAR_COUNT;
                        let material = new THREE.MeshBasicMaterial({
                            color: new THREE.Color().setHSL(hue, 0.8, 0.6)
                        });
                        let bar = new THREE.Mesh(geometry, material);
                        
                        // Arrange in a circle like the official BarVisualiser
                        let angle = (i / BAR_COUNT) * Math.PI * 2;
                        let radius = 5;
                        bar.position.x = Math.cos(angle) * radius;
                        bar.position.z = Math.sin(angle) * radius;
                        bar.position.y = 0;
                        
                        this.scene.add(bar);
                        this.bars.push(bar);
                    }
                }

                onUpdate(data) {
                    const BAR_COUNT = this.bars.length;
                    
                    for (let i = 0; i < BAR_COUNT; i++) {
                        let bar = this.bars[i];
                        let frequency = Math.abs(data.frequencyData[i]) || 0;
                        let timeDomain = Math.abs(data.timeDomainData[i]) || 0;
                        
                        // Use the same calculation as official BarVisualiser
                        let value = frequency * timeDomain;
                        if (value === Infinity || value === -Infinity || isNaN(value)) {
                            value = 0;
                        }
                        
                        // Scale the bars more aggressively for visibility
                        let targetScale = Math.max(0.1, value * 25);
                        let newY = this.lerp(bar.scale.y, targetScale, 0.2);
                        
                        bar.scale.y = newY;
                        bar.position.y = newY / 2;
                        
                        // More vibrant color changes
                        let baseHue = i / BAR_COUNT;
                        let dynamicHue = (baseHue + frequency * 0.5) % 1;
                        let saturation = 0.9;
                        let lightness = 0.4 + Math.min(0.5, frequency * 2);
                        
                        bar.material.color.setHSL(dynamicHue, saturation, lightness);
                        
                        // Debug: log some values for the first few bars
                        if (i < 3) {
                            console.log(`Bar ${i}: freq=${frequency.toFixed(3)}, time=${timeDomain.toFixed(3)}, value=${value.toFixed(3)}, scale=${newY.toFixed(3)}`);
                        }
                    }
                    
                    // Rotate camera around the bars like official version
                    this.cameraPivot.rotation.y += 0.01;
                    data.renderer.render(this.scene, this.camera);
                }

                onResize(data) {
                    this.camera.aspect = data.width / data.height;
                    this.camera.updateProjectionMatrix();
                }

                onDestroy() {
                    delete this.scene;
                    delete this.camera;
                    delete this.bars;
                }
            }

            // Starting Akko and adding multiple visualisers
            var akko = new Akko({
                autoPlay: true,
                useDefaultVisualisers: false,
            });
            
            // Add all our custom visualizers with error handling
            try {
                console.log('Adding CustomVisualiser...');
                akko.addVisualiser(new CustomVisualiser());
                console.log('✅ CustomVisualiser added');
            } catch (e) {
                console.error('❌ CustomVisualiser failed:', e);
            }
            
            try {
                console.log('Adding WaveVisualiser...');
                var waveVis = new WaveVisualiser();
                console.log('WaveVisualiser created:', waveVis);
                akko.addVisualiser(waveVis);
                console.log('✅ WaveVisualiser added');
            } catch (e) {
                console.error('❌ WaveVisualiser failed:', e);
            }
            
            try {
                console.log('Adding SphereVisualiser...');
                akko.addVisualiser(new SphereVisualiser());
                console.log('✅ SphereVisualiser added');
            } catch (e) {
                console.error('❌ SphereVisualiser failed:', e);
            }
            
            try {
                console.log('Adding BarsVisualiser...');
                var barsVis = new BarsVisualiser();
                console.log('BarsVisualiser created:', barsVis);
                akko.addVisualiser(barsVis);
                console.log('✅ BarsVisualiser added');
            } catch (e) {
                console.error('❌ BarsVisualiser failed:', e);
            }
            
            // Check what visualizers are available
            setTimeout(function() {
                console.log('Available visualizers after 2 seconds:');
                console.log('Akko object keys:', Object.keys(akko));
                
                // Try different property names
                var visualizers = akko.visualisers || akko.visualizers || akko._visualisers || akko._visualizers;
                if (visualizers) {
                    console.log('Visualizer count:', visualizers.length);
                    visualizers.forEach(function(vis, index) {
                        console.log(index + ':', vis.name || vis.constructor.name, vis.code);
                    });
                } else {
                    console.log('No visualizers found. Trying to inspect akko object...');
                    // Check visCore for visualizers
                    if (akko.visCore && akko.visCore.visualisers) {
                        console.log('Found visualizers in visCore:', akko.visCore.visualisers.length);
                        akko.visCore.visualisers.forEach(function(vis, index) {
                            console.log(index + ':', vis.name, vis.code, 'initialized:', vis.initialised);
                        });
                    }
                    
                    for (var prop in akko) {
                        if (Array.isArray(akko[prop]) && akko[prop].length > 0) {
                            console.log('Found array property:', prop, 'with', akko[prop].length, 'items');
                        }
                    }
                }
            }, 2000);
            akko.addTrack('/mixer/audio/Fatal Force - Fan Girls.mp3');
            akko.addTrack('/mixer/audio/Computer Music All-Stars - Albatross v2.mp3');
            akko.start();
        </script>

    </body>
</html>
